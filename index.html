<!doctype html>
<html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>نظام إدارة الاشتراكات V 1.0.5</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
        <style>
            /* أنماط CSS معدلة */
            :root {
                --primary: #2c786c;
                --secondary: #004445;
                --accent: #f8b400;
                --light: #faf5e4;
                --gray: #6c757d;
                --success: #28a745;
                --danger: #dc3545;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: "Tajawal", sans-serif;
            }

            body {
                background-color: #f5f7fa;
                color: #333;
                direction: rtl;
                min-height: 100vh;
                overflow-x: hidden;
            }

            .container {
                display: grid;
                grid-template-columns: 250px 1fr;
                min-height: 100vh;
                transition: all 0.3s ease;
            }

            /* الشريط الجانبي - تم التعديل */
            .sidebar {
                background: linear-gradient(
                    to bottom,
                    var(--secondary),
                    var(--primary)
                );
                color: white;
                padding: 20px 0;
                box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
                position: relative;
                z-index: 100;
                overflow-y: auto;
            }

            /* زر القائمة للجوال */
            .menu-toggle {
                display: none;
                position: fixed;
                top: 15px;
                right: 15px;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 5px;
                padding: 10px;
                z-index: 1000;
                cursor: pointer;
            }

            .logo {
                text-align: center;
                padding: 20px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                position: relative;
            }

            .logo h1 {
                font-size: 1.5rem;
                font-weight: 700;
            }

            .logo span {
                color: var(--accent);
            }

            .nav-links {
                margin-top: 30px;
            }

            .nav-links li {
                list-style: none;
                padding: 15px 25px;
                transition: all 0.3s;
                cursor: pointer;
            }

            .nav-links li:hover,
            .nav-links li.active {
                background: rgba(255, 255, 255, 0.1);
                border-right: 4px solid var(--accent);
            }

            .nav-links li i {
                margin-left: 10px;
                width: 25px;
                text-align: center;
            }

            /* المحتوى الرئيسي */
            .main-content {
                padding: 20px;
                overflow-y: auto;
                transition: all 0.3s ease;
            }

            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding-bottom: 15px;
                border-bottom: 1px solid #eee;
            }

            .header h2 {
                color: var(--secondary);
                font-weight: 700;
            }

            .user-info {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .user-info img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
            }

            /* بطاقات الإحصائيات */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: white;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                transition: transform 0.3s;
            }

            .stat-card:hover {
                transform: translateY(-5px);
            }

            .stat-card .icon {
                width: 60px;
                height: 60px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 15px;
                font-size: 24px;
            }

            .stat-card:nth-child(1) .icon {
                background: rgba(44, 120, 108, 0.2);
                color: var(--primary);
            }
            .stat-card:nth-child(2) .icon {
                background: rgba(248, 180, 0, 0.2);
                color: var(--accent);
            }
            .stat-card:nth-child(3) .icon {
                background: rgba(40, 167, 69, 0.2);
                color: var(--success);
            }
            .stat-card:nth-child(4) .icon {
                background: rgba(220, 53, 69, 0.2);
                color: var(--danger);
            }

            .stat-card h3 {
                font-size: 1.8rem;
                margin-bottom: 5px;
                font-weight: 700;
            }

            .stat-card p {
                color: var(--gray);
                font-size: 0.9rem;
            }

            /* الأقسام */
            .section {
                background: white;
                border-radius: 10px;
                padding: 25px;
                margin-bottom: 30px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            }

            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid #eee;
            }

            .section-title {
                color: var(--secondary);
                font-weight: 700;
                font-size: 1.2rem;
            }

            .btn {
                padding: 8px 20px;
                border-radius: 6px;
                border: none;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s;
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover {
                background: var(--secondary);
            }

            .btn-accent {
                background: var(--accent);
                color: white;
            }

            .btn-success {
                background: var(--success);
                color: white;
            }

            .btn-danger {
                background: var(--danger);
                color: white;
            }

            /* الجداول */
            .table-container {
                overflow-x: auto;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th,
            td {
                padding: 15px;
                text-align: right;
                border-bottom: 1px solid #eee;
            }

            th {
                background-color: #f8f9fa;
                color: var(--secondary);
                font-weight: 700;
            }

            tr:hover {
                background-color: #f8f9fa;
            }

            .action-btn {
                padding: 5px 10px;
                border-radius: 4px;
                border: none;
                margin: 0 3px;
                cursor: pointer;
                font-size: 0.9rem;
            }

            .btn-edit {
                background: rgba(44, 120, 108, 0.1);
                color: var(--primary);
            }

            .btn-delete {
                background: rgba(220, 53, 69, 0.1);
                color: var(--danger);
            }

            .btn-deduct {
                background: rgba(248, 180, 0, 0.1);
                color: var(--accent);
            }

            /* النماذج */
            .form-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: var(--secondary);
                font-weight: 500;
            }

            .form-control {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 1rem;
            }

            .form-control:focus {
                outline: none;
                border-color: var(--primary);
            }

            /* الرسومات البيانية */
            .charts {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-top: 20px;
            }

            .chart-container {
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            }

            .chart-placeholder {
                height: 300px;
                background: #f8f9fa;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--gray);
            }

            /* Modal */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
            }

            .modal-content {
                background-color: white;
                margin: 5% auto;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                width: 80%;
                max-width: 600px;
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid #eee;
            }

            .modal-title {
                color: var(--secondary);
                font-weight: 700;
                font-size: 1.5rem;
            }

            .close-btn {
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--gray);
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
            }

            /* رسومات متحركة */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .stat-card,
            .section {
                animation: fadeIn 0.5s ease-out;
            }

            /* التكيف مع الشاشات الصغيرة - تم التعديل بشكل كبير */
            @media (max-width: 992px) {
                .container {
                    grid-template-columns: 1fr;
                }

                .menu-toggle {
                    display: block;
                }

                .sidebar {
                    position: fixed;
                    top: 0;
                    right: -250px;
                    width: 250px;
                    height: 100%;
                    z-index: 100;
                    transition: right 0.3s ease;
                }

                .sidebar.active {
                    right: 0;
                    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
                }

                .main-content {
                    width: 100%;
                    padding: 70px 15px 15px;
                }

                .header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 15px;
                }

                .charts {
                    grid-template-columns: 1fr;
                }

                .form-row {
                    grid-template-columns: 1fr;
                }

                .user-info {
                    align-self: flex-end;
                }
            }

            @media (max-width: 576px) {
                .stats-grid {
                    grid-template-columns: 1fr;
                }

                .search-filter {
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                }

                .search-filter input {
                    width: 100% !important;
                }

                .section-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 15px;
                }
            }

            /* تنبيهات */
            .alert {
                padding: 15px;
                margin: 15px 0;
                border-radius: 5px;
                font-weight: 500;
            }

            .alert-success {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .alert-error {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .alert-info {
                background-color: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }

            .status-badge {
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 0.85rem;
                font-weight: 500;
            }
            .status-active {
                background-color: #d4edda;
                color: #155724;
            }
            .status-inactive {
                background-color: #fff3cd;
                color: #856404;
            }
            .status-suspended {
                background-color: #f8d7da;
                color: #721c24;
            }
            #qrModal .modal-content {
                border-radius: 10px;
                background: #f9f9f9;
            }

            #qrcode {
                margin: 0 auto;
                display: flex;
                justify-content: center;
            }

            #qrcode img {
                border: 1px solid #ddd;
                padding: 5px;
                background: white;
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                border-bottom: 1px solid #eee;
            }

            /* أنماط الطباعة */
            @media print {
                body * {
                    visibility: hidden;
                }
                #qrcode-container,
                #qrcode-container * {
                    visibility: visible;
                }
                #qrcode-container {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 100%;
                }
                #qrcode img {
                    width: 3cm !important;
                    height: 3cm !important;
                }
            }
            .btn-warning {
    background: #ffc107;
    color: #000;
    border: none;
}

.btn-warning:hover {
    background: #e0a800;
    color: #000;
}

#restorePreview {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    border-left: 4px solid #ffc107;
}

#restorePreview h5 {
    margin-bottom: 10px;
    color: #495057;
}

#restorePreview p {
    margin: 5px 0;
    color: #6c757d;
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
    padding: 12px;
    border-radius: 5px;
    margin-bottom: 15px;
}

            /* طبقة الخلفية للقائمة الجانبية على الجوال */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 90;
            }

            .sidebar-overlay.active {
                display: block;
            }
            .report-summary {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.summary-table {
    width: 100%;
    border-collapse: collapse;
}

.summary-table th, .summary-table td {
    padding: 12px 15px;
    text-align: right;
    border-bottom: 1px solid #eee;
}

.summary-table th {
    background-color: #e9ecef;
    width: 30%;
}

.meal-logs h4 {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
    color: var(--secondary);
}
#usersContent .table-container {
    max-height: 500px;
    overflow-y: auto;
}

#usersContent table {
    width: 100%;
    border-collapse: collapse;
}

#usersContent th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
}

#userModal .form-group {
    margin-bottom: 20px;
}

#userModal .form-control {
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 12px 15px;
    font-size: 1rem;
}

#userModal .form-control:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 120, 108, 0.2);
}

@media (max-width: 768px) {
    #usersContent .search-filter {
        flex-direction: column;
        gap: 10px;
    }
    
    #usersContent .search-filter input {
        width: 100% !important;
    }
}
.backup-controls {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

#backupsTable th:nth-child(1) { width: 40%; }
#backupsTable th:nth-child(2) { width: 15%; }
#backupsTable th:nth-child(3) { width: 25%; }
#backupsTable th:nth-child(4) { width: 20%; }

.btn-sm {
    padding: 5px 10px;
    font-size: 0.85rem;
}
#clientsList tr {
    cursor: pointer;
}

#clientsList tr:hover {
    background-color: #f5f5f5;
}

#notificationStatus {
    font-size: 14px;
    color: var(--gray);
}

/* تخصيص خانة الاختيار */
#clientsList input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* تصميم responsive للجدول */
@media (max-width: 768px) {
    #clientsList table {
        font-size: 0.9rem;
    }
    
    #clientsList th:nth-child(2),
    #clientsList td:nth-child(2) {
        display: none;
    }
}
        </style>
    </head>
    <body>
        <!-- طبقة خلفية للقائمة الجانبية على الجوال -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- زر القائمة للجوال -->
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>

        <div class="container">
            <!-- الشريط الجانبي -->
            <div class="sidebar" id="sidebar">
                <div class="logo">
                    <h1>نظام <span>الاشتراكات </span></h1>
                </div>
                <ul class="nav-links">
                    <li class="active">
                        <i class="fas fa-home"></i>لوحة التحكم
                    </li>
                    <li id="subscribersTab">
                        <i class="fas fa-users"></i> المشتركين
                    </li>
                   <!--
<li id="menuTab">
    <i class="fas fa-utensils"></i> قائمة الطعام
</li>
-->

                    <li id="packagesTab">
                        <i class="fas fa-box-open"></i> الباقات
                    </li>
                    <li id="subscriptionRequestsTab">
                        <i class="fas fa-clipboard-list"></i> طلبات الاشتراك
                    </li>
                    <li onclick="showSection('reportsContent')">
                        <i class="fas fa-chart-bar"></i>
                        <span>التقارير</span>
                    </li>
                    <li id="logsTab">
        <i class="fas fa-history"></i> السجلات
    </li>
                    <li id="usersTab">
    <i class="fas fa-users-cog"></i> إدارة المستخدمين
</li>
<li id="notificationsTab">
    <i class="fas fa-bell"></i> الإشعارات
</li>
                 <li id="settingsTab">
    <i class="fas fa-cog"></i> الإعدادات
</li>
                </ul>
            </div>

            <!-- المحتوى الرئيسي -->
            <div class="main-content">
                <div class="header">
                    <h2>لوحة التحكم</h2>
                    <div class="user-info">
                        <div>
                            <h3>بكري محمد</h3>
                            <p>مدير النظام</p>
                             <button class="btn btn-danger" onclick="logout()" style="margin-top: 5px; padding: 5px 10px;">
            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
        </button>
                        </div>
                        <img
                            src="https://randomuser.me/api/portraits/men/41.jpg"
                            alt="صورة المستخدم"
                        />
                    </div>
                </div>

                <!-- بطاقات الإحصائيات -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 id="totalSubscribers">0</h3>
                        <p>إجمالي المشتركين</p>
                    </div>

                    <div class="stat-card">
                        <div class="icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <h3 id="activeSubscribers">0</h3>
                        <p>مشتركين نشطين</p>
                    </div>

                    <div class="stat-card">
                        <div class="icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <h3 id="popularPackage">0</h3>
                        <p>باقة الأكثر مبيعاً</p>
                    </div>
                </div>

                <!-- قسم المشتركين -->
                <div id="subscribersContent" class="section">
                    <div class="section-header">
                        <h3 class="section-title">إدارة المشتركين</h3>
                        <button class="btn btn-primary" id="addSubscriberBtn">
                            <i class="fas fa-plus"></i> إضافة مشترك جديد
                        </button>
                    </div>
                    <div class="search-filter" style="margin-bottom: 15px">
                        <input
                            type="text"
                            id="subscriberSearch"
                            class="form-control"
                            placeholder="ابحث باسم المشترك أو رقم الجوال..."
                            style="width: 300px; display: inline-block"
                            onkeypress="handleSubscriberSearch(event)"
                        />
                        <button
                            class="btn btn-primary"
                            onclick="filterSubscribers()"
                        >
                            <i class="fas fa-search"></i> بحث
                        </button>
                        <button
                            class="btn btn-danger"
                            onclick="resetSubscriberFilter()"
                        >
                            <i class="fas fa-times"></i> إعادة تعيين
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>الاسم</th>
                                    <th>رقم الجوال</th>
                                    <th>تاريخ الاشتراك</th>
                                    <th>نوع الاشتراك</th>
                                    <th>الوجبات المتبقية</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="subscribersTableBody">
                                <!-- سيتم ملؤها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="menuContent" class="section" style="display: none">
                    <div class="section-header">
                        <h3 class="section-title">قائمة الطعام</h3>
                        <button class="btn btn-primary" id="addItemBtn">
                            <i class="fas fa-plus"></i> إضافة صنف
                        </button>
                    </div>
                    <div id="itemModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">إضافة صنف جديد</h3>
                                <button class="close-btn" id="closeItemModal">
                                    &times;
                                </button>
                            </div>
                            <form id="itemForm">
                                <div class="form-group">
                                    <label for="item_name">اسم الصنف:</label>
                                    <input
                                        type="text"
                                        id="item_name"
                                        name="item_name"
                                        class="form-control"
                                        required
                                    />
                                </div>
                                <div class="form-group">
                                    <label for="item_price"
                                        >السعر (ريال):</label
                                    >
                                    <input
                                        type="number"
                                        id="item_price"
                                        name="item_price"
                                        class="form-control"
                                        required
                                    />
                                </div>
                                <div
                                    class="form-group"
                                    style="margin-top: 20px"
                                >
                                    <button
                                        type="submit"
                                        class="btn btn-primary"
                                    >
                                        حفظ الصنف
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-danger"
                                        id="cancelItemBtn"
                                    >
                                        إلغاء
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>اسم الصنف</th>
                                    <th>السعر</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="menuTableBody">
                                <!-- سيتم ملؤها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="packagesContent" class="section" style="display: none">
                    <div class="section-header">
                        <h3 class="section-title">الباقات المتوفرة</h3>
                        <button class="btn btn-primary" id="addPackageBtn">
                            <i class="fas fa-plus"></i> إضافة باقة
                        </button>
                    </div>
                    <div class="search-filter" style="margin-bottom: 15px">
                        <input
                            type="text"
                            id="packageSearch"
                            class="form-control"
                            placeholder="ابحث باسم الباقة..."
                            style="width: 300px; display: inline-block"
                            onkeypress="handlePackageSearch(event)"
                        />
                        <button
                            class="btn btn-primary"
                            onclick="filterPackages()"
                        >
                            <i class="fas fa-search"></i> بحث
                        </button>
                        <button
                            class="btn btn-danger"
                            onclick="resetPackageFilter()"
                        >
                            <i class="fas fa-times"></i> إعادة تعيين
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>رقم الباقة</th>
                                    <th>اسم الباقة</th>
                                    <th>السعر</th>
                                    <th>عدد الوجبات</th>
                                    <th>صلاحية الاشتراك</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody">
                                <!-- سيتم تعبئتها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- قسم طلبات الاشتراك -->
                <div
                    id="subscriptionRequestsContent"
                    class="section"
                    style="display: none"
                >
                    <div class="section-header">
                        <h3 class="section-title">طلبات الاشتراك</h3>
                        <button
                            class="btn btn-primary"
                            onclick="loadSubscriptionRequests()"
                        >
                            <i class="fas fa-sync-alt"></i> تحديث
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>الاسم</th>
                                    <th>رقم الجوال</th>
                                    <th>نوع الاشتراك</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionRequestsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center">
                                        جاري تحميل البيانات...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- قسم التقارير -->
                <div id="reportsContent" class="section" style="display: none">
    <div class="section-header">
        <h3 class="section-title">التقارير</h3>
    </div>

    <div class="form-group">
        <label for="reportSubscriberId">أدخل رقم المشترك:</label>
        <div style="display: flex; gap: 10px;">
            <input
                type="text"
                id="reportSubscriberId"
                class="form-control"
                placeholder="مثال: 3"
                style="flex: 1;"
            />
            <button class="btn btn-primary" onclick="generateReport()">
                بحث
            </button>
        </div>
    </div>

    <div id="reportResult" style="margin-top: 30px">
        <!-- سيتم عرض الإحصائية والتفاصيل هنا -->
    </div>
</div>
<div id="logsContent" class="section" style="display: none">
    <div class="section-header">
        <h3 class="section-title">سجلات النظام</h3>
        <button class="btn btn-primary" onclick="loadLogs()">
            <i class="fas fa-sync-alt"></i> تحديث
        </button>
    </div>
    <div class="search-filter" style="margin-bottom: 15px">
        <input
            type="text"
            id="logsSearch"
            class="form-control"
            placeholder="ابحث في السجلات..."
            style="width: 300px; display: inline-block"
        />
        <button class="btn btn-primary" onclick="filterLogs()">
            <i class="fas fa-search"></i> بحث
        </button>
        <button class="btn btn-danger" onclick="resetLogsFilter()">
            <i class="fas fa-times"></i> إعادة تعيين
        </button>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>التاريخ والوقت</th>
                    <th>المستخدم</th>
                    <th>العملية</th>
                    <th>التفاصيل</th>
                </tr>
            </thead>
            <tbody id="logsTableBody">
                <!-- سيتم ملؤها بالبيانات -->
            </tbody>
        </table>
    </div>
</div>
<div id="usersContent" class="section" style="display: none">
    <div class="section-header">
        <h3 class="section-title">إدارة المستخدمين</h3>
        <button class="btn btn-primary" id="addUserBtn">
            <i class="fas fa-plus"></i> إضافة مستخدم جديد
        </button>
    </div>
    
    <div class="search-filter" style="margin-bottom: 15px">
        <input
            type="text"
            id="userSearch"
            class="form-control"
            placeholder="ابحث باسم المستخدم أو الدور..."
            style="width: 300px; display: inline-block"
        />
        <button class="btn btn-primary" onclick="filterUsers()">
            <i class="fas fa-search"></i> بحث
        </button>
        <button class="btn btn-danger" onclick="resetUserFilter()">
            <i class="fas fa-times"></i> إعادة تعيين
        </button>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>اسم المستخدم</th>
                    <th>الدور</th>
                    <th>تاريخ الإنشاء</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <!-- سيتم تعبئتها بالبيانات -->
            </tbody>
        </table>
    </div>
</div>
<!-- قسم الإعدادات -->
<div id="settingsContent" class="section" style="display: none">
    <div class="section-header">
        <h3 class="section-title">الإعدادات</h3>
    </div>
    
    <div class="form-group">
        <h4>النسخ الاحتياطي</h4>
        <div class="backup-controls">
            <button class="btn btn-primary" onclick="createBackup()">
                <i class="fas fa-download"></i> إنشاء نسخة احتياطية الآن
            </button>
            
          <!--  <button class="btn btn-warning" onclick="showRestoreModal()" style="margin-left: 10px;">
                <i class="fas fa-upload"></i> استعادة نسخة احتياطية
            </button>
            -->
            <div class="form-group" style="margin-top: 20px">
               
            </div>
        </div>
        
        <div id="backupResult" style="margin-top: 15px"></div>
        
        <h4 style="margin-top: 30px">النسخ الاحتياطية السابقة</h4>
        <div class="table-container">
            <table id="backupsTable">
                <thead>
                    <tr>
                        <th>اسم الملف</th>
                        <th>الحجم</th>
                        <th>التاريخ</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="backupsList">
                    <!-- سيتم تعبئتها بالبيانات -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- قسم الإشعارات -->
<div id="notificationsContent" class="section" style="display: none">
    <div class="section-header">
        <h3 class="section-title">إرسال الإشعارات</h3>
    </div>
    
    <div class="form-group">
        <label for="notificationMessage">نص الرسالة:</label>
        <textarea 
            id="notificationMessage" 
            class="form-control" 
            rows="5" 
            placeholder="اكتب نص الرسالة هنا..."
            style="width: 100%; resize: vertical;"
        ></textarea>
    </div>
    
    <div class="form-group" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h4>اختر العملاء المراد إرسال الإشعار لهم:</h4>
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="selectAllClients" onchange="toggleSelectAll(this)">
                تحديد الكل
            </label>
        </div>
        
        <div class="table-container" style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
            <table>
                <thead>
                    <tr>
                        <th width="50px">تحديد</th>
                        <th>اسم العميل</th>
                        <th>رقم الجوال</th>
                    </tr>
                </thead>
                <tbody id="clientsList">
                    <!-- سيتم ملؤها بالبيانات -->
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="form-group" style="margin-top: 20px; text-align: left;">
        <button id="sendNotificationBtn" class="btn btn-primary" onclick="sendNotifications()">
            <i class="fas fa-paper-plane"></i> إرسال الإشعار
        </button>
        <span id="notificationStatus" style="margin-right: 15px;"></span>
    </div>
</div>
<!-- نافذة مودال الاستعادة -->
<div id="restoreModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">استعادة نسخة احتياطية</h3>
            <button class="close-btn" onclick="closeModal('restoreModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>تحذير:</strong> الاستعادة ستحذف جميع البيانات الحالية وتستبدلها بالبيانات من النسخة الاحتياطية.
            </div>
            
            <div class="form-group">
                <label>اختر نسخة للاستعادة:</label>
                <select id="restoreFileSelect" class="form-control">
                    <option value="">-- اختر نسخة احتياطية --</option>
                    <!-- سيتم تعبئتها بالبيانات -->
                </select>
            </div>
            
            <div id="restorePreview" style="margin-top: 15px; display: none;">
                <h5>معلومات النسخة:</h5>
                <div id="backupInfo"></div>
            </div>
            
            <div class="form-group" style="margin-top: 20px">
                <button class="btn btn-danger" onclick="confirmRestore()" id="confirmRestoreBtn" disabled>
                    <i class="fas fa-check"></i> تأكيد الاستعادة
                </button>
                <button class="btn btn-secondary" onclick="closeModal('restoreModal')">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>
</div>
<!-- نافذة مودال لإضافة/تعديل المستخدم -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="userModalTitle">إضافة مستخدم جديد</h3>
            <button class="close-btn" id="closeUserModal">&times;</button>
        </div>
        <form id="userForm">
            <input type="hidden" id="userId">
            <div class="form-group">
                <label for="newUsername">اسم المستخدم</label>
                <input type="text" id="newUsername" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="newPassword">كلمة المرور</label>
                <input type="password" id="newPassword" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="confirmPassword">تأكيد كلمة المرور</label>
                <input type="password" id="confirmPassword" class="form-control" required>
            </div>
          <!--  <div class="form-group">
                <label for="userRole">الدور</label>
                <select id="userRole" class="form-control" required>
                    <option value="مدير النظام">مدير النظام</option>
                    <option value="موظف">موظف</option>
                    <option value="مشرف">مشرف</option>
                </select>
            </div>
            -->
            <div class="form-group" style="margin-top: 20px">
                <button type="submit" class="btn btn-primary">حفظ المستخدم</button>
                <button type="button" class="btn btn-danger" id="cancelUserBtn">إلغاء</button>
            </div>
        </form>
    </div>
</div>
        <!-- نافذة مودال لإضافة باقة -->
        <div id="packageModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">إضافة باقة جديدة</h3>
                    <button class="close-btn" id="closePackageModal">
                        &times;
                    </button>
                </div>
                <form id="packageForm">
                    <input type="hidden" id="edit_package_id" value="" />
                    <div class="form-group">
                        <label for="package_name">اسم الباقة:</label>
                        <input
                            type="text"
                            id="package_name"
                            class="form-control"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="package_price">السعر:</label>
                        <input
                            type="text"
                            id="package_price"
                            class="form-control"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="package_meals">عدد الوجبات:</label>
                        <input
                            type="number"
                            id="package_meals"
                            class="form-control"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="package_duration">صلاحية الاشتراك:</label>
                        <input
                            type="text"
                            id="package_duration"
                            class="form-control"
                            required
                        />
                    </div>
                    <div class="form-group" style="margin-top: 20px">
                        <button type="submit" class="btn btn-primary">
                            حفظ الباقة
                        </button>
                        <button
                            type="button"
                            class="btn btn-danger"
                            id="cancelPackageBtn"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal لإضافة المشترك -->
        <div id="subscriberModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">
                        إضافة مشترك جديد
                    </h3>
                    <button class="close-btn" id="closeModal">&times;</button>
                </div>
                <form id="subscriberForm">
                    <input type="hidden" id="subscriberId" />
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">الاسم الكامل</label>
                            <input
                                type="text"
                                id="name"
                                class="form-control"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="phone">رقم الجوال</label>
                            <input
                                type="tel"
                                id="phone"
                                class="form-control"
                                required
                            />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">تاريخ بداية الاشتراك</label>
                            <input
                                type="date"
                                id="startDate"
                                class="form-control"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="endDate">تا>�يخ نهاية الاشتراك</label>
                            <input
                                type="date"
                                id="endDate"
                                class="form-control"
                                readonly
                            />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="subscriptionType">نوع الاشتراك</label>
                            <select
                                id="subscriptionType"
                                class="form-control"
                                required
                            >
                                <option value="">اختر نوع الاشتراك</option>
                                <!-- سيتم ملؤها تلقائيًا -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="status">حالة الاشتراك</label>
                            <select id="status" class="form-control" required>
                                <option value="نشط">نشط</option>
                                <option value="غير نشط">غير نشط</option>
                                <option value="موقوف">موقوف</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 20px">
                        <button
                            type="submit"
                            class="btn btn-primary"
                            id="saveSubscriberBtn"
                        >
                            حفظ المشترك
                        </button>
                        <button
                            type="button"
                            class="btn btn-danger"
                            id="cancelBtn"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div><!-- Modal تعديل مشترك -->
       <div id="editSubscriberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تعديل بيانات المشترك</h3>
                <button class="close-btn" onclick="closeModal('editSubscriberModal')">&times;</button>
            </div>
            <form id="editSubscriberForm">
                <input type="hidden" id="edit_subscriber_id" />
                <input type="hidden" id="edit_start_date" />
                <input type="hidden" id="edit_end_date" />
                
                <div class="subscriber-details">
                    <h4>تفاصيل المشترك الحالية</h4>
                    <div class="detail-row">
                        <span class="detail-label">رقم المشترك:</span>
                        <span class="detail-value" id="current_id"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">الاسم:</span>
                        <span class="detail-value" id="current_name"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">رقم الجوال:</span>
                        <span class="detail-value" id="current_phone"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">نوع الاشتراك:</span>
                        <span class="detail-value" id="current_subscription"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">تاريخ البدء:</span>
                        <span class="detail-value" id="current_start_date"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">تاريخ الانتهاء:</span>
                        <span class="detail-value" id="current_end_date"></span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">الحالة:</span>
                        <span class="detail-value" id="current_status"></span>
                    </div>
                    <div class="meals-info">
                        <div>الوجبات المتبقية</div>
                        <div class="meals-count" id="current_meals"></div>
                    </div>
                </div>

                <h4 class="section-title">تعديل البيانات</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_name">الاسم الكامل</label>
                        <input type="text" id="edit_name" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label for="edit_phone">رقم الجوال</label>
                        <input type="tel" id="edit_phone" class="form-control" required />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_status">حالة الاشتراك</label>
                        <select id="edit_status" class="form-control" required>
                            <option value="نشط">نشط</option>
                            <option value="غير نشط">غير نشط</option>
                            <option value="موقوف">موقوف</option>
                        </select>
                    </div>
                    <div class="form-group">
        <label for="edit_meals">تعديل الوجبات المتبقية</label>
        <input type="number" id="edit_meals" class="form-control" required
               placeholder="ادخل الوجبات المتبقية" 
               min="0" />
    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="display_start_date">تاريخ البدء</label>
                        <input type="date" id="display_start_date" class="form-control" required />
                    </div>
                     <div class="form-group">
        <label for="display_end_date">تاريخ الانتهاء</label>
        <input type="date" id="display_end_date" class="form-control" required />
    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit_subscription_type">نوع الاشتراك</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <select id="edit_subscription_type" class="form-control" required>
                            <option value="">جاري تحميل الباقات...</option>
                        </select>
                        <button type="button" class="btn btn-primary" onclick="loadPackagesForEdit()" 
                                title="تحديث قائمة الباقات">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px">
                    <button type="submit" class="btn btn-primary">
                        حفظ التعديلات
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('editSubscriberModal')">
                        إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

        <div id="qrModal" class="modal">
            <div
                class="modal-content"
                style="text-align: center; max-width: 400px"
            >
                <div class="modal-header">
                    <h3 class="modal-title">كود QR للمشترك</h3>
                    <div>
                        <button
                            class="btn btn-primary"
                            onclick="saveQRCode()"
                            style="margin-left: 10px"
                        >
                            <i class="fas fa-download"></i> حفظ
                        </button>
                        <button class="close-btn" onclick="closeQRModal()">
                            &times;
                        </button>
                    </div>
                </div>
                <div
                    id="qrcode-container"
                    style="margin: 20px auto; padding: 20px; background: white"
                >
                    <div id="qrcode"></div>
                    <div id="qr-info" style="margin-top: 15px; font-size: 16px">
                        <div id="qr-name" style="font-weight: bold"></div>
                        <div id="qr-id" style="color: #666"></div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            const GOOGLE_SCRIPT_URL =
                "https://script.google.com/macros/s/AKfycbzKILlKoHN7jHoboi2KCMOpchcnAl2CH00Nieb5XWx-LIyEDL4ERcm1p_M3EhHzWjGi2Q/exec";
            // public/js/script.js
            document.addEventListener("DOMContentLoaded", function () {
                 const userSession = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
    
    if (!userSession) {
        // إذا لم يكن المستخدم مسجل الدخول، توجيهه لصفحة تسجيل الدخول
        window.location.href = 'login.html';
        return;
    }
    
    try {
        const user = JSON.parse(userSession);
        
        // عرض معلومات المستخدم في لوحة التحكم
        document.querySelector('.user-info h3').textContent = user.username;
       // document.querySelector('.user-info p').textContent = user.role;
        
        // يمكنك هنا جلب بيانات المستخدم من الخادم إذا لزم الأمر
        // loadUserData(user.user_id);
        
    } catch (e) {
        console.error('Error parsing user session:', e);
        window.location.href = 'login.html';
    }
                // تحميل الإحصائيات
                loadStats();

                // تحميل المشتركين
                loadSubscribers();

                // تحميل قائمة الطعام
                loadMenu();

                // تحميل الباقات
                loadPackages();

                // تحميل طلبات الاشتراك
                loadSubscriptionRequests();

                // إعداد معالجات الأحداث
                setupEventHandlers();

                // إعداد القائمة الجانبية للجوال
                setupMobileMenu();
            });

            // دالة جديدة لإعداد القائمة الجانبية للجوال
            function setupMobileMenu() {
                const menuToggle = document.getElementById("menuToggle");
                const sidebar = document.getElementById("sidebar");
                const sidebarOverlay =
                    document.getElementById("sidebarOverlay");

                if (menuToggle && sidebar && sidebarOverlay) {
                    menuToggle.addEventListener("click", function () {
                        sidebar.classList.toggle("active");
                        sidebarOverlay.classList.toggle("active");
                    });

                    sidebarOverlay.addEventListener("click", function () {
                        sidebar.classList.remove("active");
                        sidebarOverlay.classList.remove("active");
                    });

                    // إغلاق القائمة عند النقر على رابط
                    document
                        .querySelectorAll(".nav-links li")
                        .forEach((item) => {
                            item.addEventListener("click", function () {
                                if (window.innerWidth <= 992) {
                                    sidebar.classList.remove("active");
                                    sidebarOverlay.classList.remove("active");
                                }
                            });
                        });
                }
            }

            function setupEventHandlers() {
                // التنقل بين الأقسام
                document
                    .getElementById("subscribersTab")
                    .addEventListener("click", () =>
                        showSection("subscribersContent"),
                    );
               /* document
                    .getElementById("menuTab")
                    .addEventListener("click", () =>
                        showSection("menuContent"),
                    );
                    */
                document
                    .getElementById("packagesTab")
                    .addEventListener("click", () =>
                        showSection("packagesContent"),
                    );
                document
                    .getElementById("subscriptionRequestsTab")
                    .addEventListener("click", () =>
                        showSection("subscriptionRequestsContent"),
                    );

                // إضافة مشترك جديد
                document
                    .getElementById("addSubscriberBtn")
                    .addEventListener("click", () => openSubscriberModal());

                // إضافة صنف جديد
                document
                    .getElementById("addItemBtn")
                    .addEventListener("click", () => openItemModal());

                // إضافة باقة جديدة
                document
                    .getElementById("addPackageBtn")
                    .addEventListener("click", () => {
                        openPackageModal();
                    });

                // إغلاق النوافذ المنبثقة
                document
                    .getElementById("closeModal")
                    .addEventListener("click", () =>
                        closeModal("subscriberModal"),
                    );
                document
                    .getElementById("closeItemModal")
                    .addEventListener("click", () => closeModal("itemModal"));
                document
                    .getElementById("closePackageModal")
                    .addEventListener("click", () =>
                        closeModal("packageModal"),
                    );

                // إلغاء النوافذ المنبثقة
                document
                    .getElementById("cancelBtn")
                    .addEventListener("click", () =>
                        closeModal("subscriberModal"),
                    );
                document
                    .getElementById("cancelItemBtn")
                    .addEventListener("click", () => closeModal("itemModal"));
                document
                    .getElementById("cancelPackageBtn")
                    .addEventListener("click", () =>
                        closeModal("packageModal"),
                    );

                // تقديم النماذج
                document
                    .getElementById("subscriberForm")
                    .addEventListener("submit", handleSubscriberSubmit);
                document
                    .getElementById("itemForm")
                    .addEventListener("submit", handleItemSubmit);
                document
                    .getElementById("packageForm")
                    .addEventListener("submit", handlePackageSubmit);
                // حساب تاريخ الانتهاء تلقائياً عند تغيير الباقة أو تاريخ البداية
                document
                    .getElementById("subscriptionType")
                    .addEventListener("change", updateEndDate);
                document
                    .getElementById("startDate")
                    .addEventListener("change", updateEndDate);
                 document.getElementById("usersTab").addEventListener("click", () => {
    showSection("usersContent");
    loadUsers();
});
  document.getElementById("settingsTab").addEventListener("click", () => {
    showSection("settingsContent");
     loadBackups();
});
document.getElementById("addUserBtn").addEventListener("click", () => {
    openUserModal();
});

document.getElementById("closeUserModal").addEventListener("click", () => {
    closeModal("userModal");
});

document.getElementById("cancelUserBtn").addEventListener("click", () => {
    closeModal("userModal");
});

document.getElementById("userForm").addEventListener("submit", handleUserSubmit);
// في دالة setupEventHandlers، إضافة مستمع الحدث لزر السجلات
  document.getElementById("logsTab").addEventListener("click", showLogsSection);
// دالة لتحميل المستخدمين
document.getElementById("notificationsTab").addEventListener("click", () => {
    showSection("notificationsContent");
    loadClientsForNotifications();
});
function loadUsers(search = "") {
    fetch(`/newstart/api/users?search=${encodeURIComponent(search)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const tbody = document.getElementById("usersTableBody");
            tbody.innerHTML = "";

            // تأكد أن البيانات هي مصفوفة
            const users = Array.isArray(data) ? data : [];

            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">لا يوجد مستخدمين</td></tr>`;
                return;
            }

            users.forEach((user, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.username}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editUser('${user.user_id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteUser('${user.user_id}', '${user.username}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error("Error loading users:", error);
            showAlert("حدث خطأ أثناء تحميل المستخدمين", "error");
        });
}

// دالة لفتح نافذة إضافة/تعديل المستخدم
function openUserModal(user = null) {
    const modal = document.getElementById("userModal");
    const form = document.getElementById("userForm");
    
    form.reset();
    document.getElementById("userId").value = "";
    
    if (user) {
        document.getElementById("userModalTitle").textContent = "تعديل المستخدم";
        document.getElementById("userId").value = user.user_id;
        document.getElementById("newUsername").value = user.username;
       // document.getElementById("userRole").value = user.role;
        document.getElementById("newPassword").required = false;
        document.getElementById("confirmPassword").required = false;
    } else {
        document.getElementById("userModalTitle").textContent = "إضافة مستخدم جديد";
        document.getElementById("newPassword").required = true;
        document.getElementById("confirmPassword").required = true;
    }
    
    modal.style.display = "block";
}

// دالة لتقديم نموذج المستخدم
async function handleUserSubmit(e) {
    e.preventDefault();
    
    const userId = document.getElementById("userId").value;
    const username = document.getElementById("newUsername").value;
    const password = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    const isEditMode = !!userId;
    
    // التحقق من تطابق كلمات المرور (للمستخدمين الجدد فقط)
    if (!isEditMode && password !== confirmPassword) {
        showAlert("كلمتا المرور غير متطابقتين", "error");
        return;
    }
    
    // إنشاء البيانات التي سترسل للـ API
    const formData = {
        username,
        actionUser: getActionUser() // إضافة المستخدم الذي يقوم بالإجراء
    };
    if (!isEditMode || password) {
        formData.password = password;
    }
    
    const url = isEditMode ? `/newstart/api/users/${userId}` : "/newstart/api/users";
    const method = isEditMode ? "PUT" : "POST";
    
    try {
        const response = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || "حدث خطأ أثناء حفظ المستخدم");
        }
        
        showAlert(
            isEditMode ? "تم تحديث المستخدم بنجاح" : "تم إضافة المستخدم بنجاح",
            "success"
        );
        
        closeModal("userModal");
        loadUsers();
    } catch (error) {
        console.error("Error:", error);
        showAlert(error.message, "error");
    }
}
// دالة لتعديل المستخدم
async function editUser(userId) {
    try {
        const response = await fetch(`/newstart/api/users/${userId}`);
        const user = await response.json();
        
        if (!response.ok) {
            throw new Error(user.error || "حدث خطأ أثناء جلب بيانات المستخدم");
        }
        
        openUserModal(user);
    } catch (error) {
        console.error("Error:", error);
        showAlert(error.message, "error");
    }
}

// دالة لحذف المستخدم
function deleteUser(userId, username) {
    if (confirm(`هل أنت متأكد من حذف المستخدم "${username}"؟`)) {
        fetch(`/newstart/api/users/${userId}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ actionUser: getActionUser() }) // هنا يمرر اليوزر
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert("تم حذف المستخدم بنجاح", "success");
                loadUsers();
            } else {
                throw new Error(data.error || "حدث خطأ أثناء حذف المستخدم");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            showAlert(error.message, "error");
        });
    }
}

// دالة لتصفية المستخدمين
function filterUsers() {
    const search = document.getElementById("userSearch").value;
    loadUsers(search);
}

// دالة لإعادة تعيين التصفية
function resetUserFilter() {
    document.getElementById("userSearch").value = "";
    loadUsers();
}

// جعل الدوال متاحة عالمياً
window.editUser = editUser;
window.deleteUser = deleteUser;
window.filterUsers = filterUsers;
window.resetUserFilter = resetUserFilter;
                function updateEndDate() {
                    const startDate =
                        document.getElementById("startDate").value;
                    const subscriptionType =
                        document.getElementById("subscriptionType");
                    const selectedOption =
                        subscriptionType.options[
                            subscriptionType.selectedIndex
                        ];
                    const days = selectedOption.getAttribute("data-days");

                    if (startDate && days) {
                        const endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + parseInt(days));
                        document.getElementById("endDate").value = endDate
                            .toISOString()
                            .split("T")[0];
                    }
                }
            }

            function showSection(sectionId) {
                // إخفاء جميع الأقسام
                document.querySelectorAll(".section").forEach((section) => {
                    section.style.display = "none";
                });

                // إظهار القسم المطلوب
                document.getElementById(sectionId).style.display = "block";

                // تحديث البيانات عند التبديل
                if (sectionId === "subscribersContent") loadSubscribers();
                if (sectionId === "menuContent") loadMenu();
                if (sectionId === "packagesContent") loadPackages();
                if (sectionId === "subscriptionRequestsContent")
                    loadSubscriptionRequests();
            }

            function loadStats() {
                fetch("/newstart/api/stats")
                    .then((response) => response.json())
                    .then((data) => {
                        document.getElementById(
                            "totalSubscribers",
                        ).textContent = data.totalSubscribers;
                        document.getElementById(
                            "activeSubscribers",
                        ).textContent = data.activeSubscribers;
                        document.getElementById("popularPackage").textContent =
                            data.popularPackage;
                    })
                    .catch((error) =>
                        console.error("Error loading stats:", error),
                    );
            }

            function loadSubscribers(search = "") {
                fetch(`/newstart/api/subscribers?search=${encodeURIComponent(search)}`)
                    .then((response) => response.json())
                    .then((subscribers) => {
                        const tbody = document.getElementById(
                            "subscribersTableBody",
                        );
                        tbody.innerHTML = "";

                        subscribers.forEach((sub) => {
                            const tr = document.createElement("tr");
                            tr.setAttribute(
                                "data-subscriber-id",
                                sub.subscriber_id,
                            );

                            // الهروب من الأحرف الخاصة
                            const escapedName = escapeHtml(sub.name);
                            const escapedType = escapeHtml(
                                sub.subscription_type,
                            );
                            const mealsRemaining =
                                sub.meals_remaining - (sub.meals_deducted || 0);

                            tr.innerHTML = `
                            <td>${sub.subscriber_id}</td>
                            <td>${escapedName}</td>
                            <td>${sub.phone}</td>
                            <td>${sub.start_date}</td>
                            <td>${escapedType}</td>
                            <td class="meals-remaining">${mealsRemaining}</td>
                            <td><span class="status-badge ${getStatusClass(sub.status)}">${sub.status}</span></td>
                            <td>
                                <button class="action-btn btn-edit" onclick="editSubscriber(${sub.subscriber_id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteSubscriber(${sub.subscriber_id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="action-btn btn-deduct" 
                                        onclick="deductMeal(${sub.subscriber_id}, '${escapedName.replace(/'/g, "\\'")}', '${escapedType.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-utensil-spoon"></i>
                                </button>
                                <button class="action-btn" onclick="generateQR(${sub.subscriber_id}, '${escapedName.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-qrcode"></i>
                                </button>
                            </td>
                        `;

                            tbody.appendChild(tr);
                        });
                    })
                    .catch((error) => {
                        console.error("Error loading subscribers:", error);
                        showAlert("حدث خطأ أثناء تحميل المشتركين", "error");
                    });
            }

            // دالة مساعدة للهروب من الأحرف الخاصة
            function escapeHtml(unsafe) {
                if (!unsafe) return "";
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function loadMenu() {
                fetch("/newstart/api/menu")
                    .then((response) => response.json())
                    .then((menuItems) => {
                        const tbody = document.getElementById("menuTableBody");
                        tbody.innerHTML = "";

                        menuItems.forEach((item) => {
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                            <td>${item.item_name}</td>
                            <td>${item.price} ريال</td>
                            <td>
                                <button class="action-btn btn-edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                            tbody.appendChild(tr);
                        });
                    })
                    .catch((error) =>
                        console.error("Error loading menu:", error),
                    );
            }

            function loadPackages(search = "") {
                fetch(`/newstart/api/packages?search=${encodeURIComponent(search)}`)
                    .then((response) => response.json())
                    .then((packages) => {
                        const tbody =
                            document.getElementById("packagesTableBody");
                        tbody.innerHTML = "";

                        packages.forEach((pkg) => {
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                            <td>${pkg.package_id}</td>
                            <td>${pkg.package_name}</td>
                            <td>${pkg.price} ريال</td>
                            <td>${pkg.meals_count}</td>
                            <td>${pkg.subscription_days} يوم</td>
                            <td>
                                <button class="action-btn btn-edit" onclick="editPackage(${pkg.package_id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-delete" onclick="deletePackage(${pkg.package_id}, '${pkg.package_name}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                            tbody.appendChild(tr);
                        });
                    })
                    .catch((error) => {
                        console.error("Error loading packages:", error);
                        showAlert("حدث خطأ أثناء تحميل الباقات", "error");
                    });
            }

            async function loadSubscriptionRequests() {
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getOrders`);
        if (!response.ok) throw new Error(`خطأ في الاستجابة: ${response.status}`);
        
        const data = await response.json();
        const tableBody = document.getElementById("subscriptionRequestsTableBody");
        tableBody.innerHTML = "";

        let requestsArray = [];
        if (Array.isArray(data)) requestsArray = data;
        else if (typeof data === "object" && data !== null) 
            requestsArray = Object.keys(data).map(key => data[key]);

        if (requestsArray.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center">لا توجد طلبات حالية</td></tr>`;
            return;
        }

        requestsArray.forEach((request, index) => {
            const requestData = {
                id: request.id || request.id || "غير محدد", // تأكد من وجود ID
                name: request.name || request.الاسم || "غير محدد",
                phone: request.phone || request.رقم_الجوال || "غير محدد",
                package: request.package || request.نوع_الاشتراك || "غير محدد",
                status: request.status || request.الحالة || "قيد الانتظار"
            };

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${requestData.id}</td>
                <td>${requestData.name}</td>
                <td>${requestData.phone}</td>
                <td>${requestData.package}</td>
                <td>${requestData.status}</td>
                <td>
                  <button class="btn btn-success" onclick="approveRequest('${requestData.phone}', '${requestData.name}', '${requestData.package}', '${requestData.id}')">
    <i class="fas fa-check"></i> حفظ
</button>
                    <button class="btn btn-danger" onclick="rejectRequest('${requestData.id}')">
                        <i class="fas fa-times"></i> حذف
                    </button>
                </td>
            `;
            tableBody.appendChild(tr);
        });
    } catch (error) {
        console.error("تفاصيل الخطأ:", error);
        showAlert(`حدث خطأ أثناء جلب طلبات الاشتراك: ${error.message}`, "error");
    }
}

            function openSubscriberModal(subscriber = null) {
                const modal = document.getElementById("subscriberModal");
                const form = document.getElementById("subscriberForm");

                // إعادة تعيين النموذج دائماً قبل فتحه
                form.reset();

                // تعيين عنوان النافذة المنبثقة
                document.getElementById("modalTitle").textContent = subscriber
                    ? "تعديل مشترك"
                    : "إضافة مشترك جديد";

                // تعيين قيمة مخفية للمشترك الموجود
                document.getElementById("subscriberId").value = subscriber
                    ? subscriber.subscriber_id
                    : "";

                // تعبئة البيانات إذا كان تعديل مشترك موجود
                if (subscriber) {
                    document.getElementById("name").value =
                        subscriber.name || "";
                    document.getElementById("phone").value =
                        subscriber.phone || "";
                    document.getElementById("startDate").value =
                        subscriber.start_date || "";
                    document.getElementById("endDate").value =
                        subscriber.end_date || "";
                    document.getElementById("status").value =
                        subscriber.status || "نشط";
                } else {
                    // تعيين القيم الافتراضية للمشترك الجديد
                    const today = new Date().toISOString().split("T")[0];
                    document.getElementById("startDate").value = today;
                    document.getElementById("status").value = "نشط";
                }

                // تحميل الباقات
                loadSubscriptionTypes(subscriber);

                // إظهار النافذة المنبثقة
                modal.style.display = "block";
            }

            function loadSubscriptionTypes(subscriber = null) {
                const subscriptionTypeSelect =
                    document.getElementById("subscriptionType");
                subscriptionTypeSelect.innerHTML =
                    '<option value="">جاري تحميل الباقات...</option>';

                fetch("/newstart/api/packages/list")
                    .then((response) => {
                        if (!response.ok)
                            throw new Error("Network response was not ok");
                        return response.json();
                    })
                    .then((packages) => {
                        subscriptionTypeSelect.innerHTML =
                            '<option value="">اختر نوع الاشتراك</option>';

                        packages.forEach((pkg) => {
                            const option = document.createElement("option");
                            option.value = `${pkg.package_name} - ${pkg.subscription_days} يوم - ${pkg.price} ريال (${pkg.meals_count} وجبة)`;
                            option.textContent = `${pkg.package_name} - ${pkg.subscription_days} يوم - ${pkg.price} ريال (${pkg.meals_count} وجبة)`;
                            option.setAttribute("data-meals", pkg.meals_count);
                            option.setAttribute(
                                "data-days",
                                pkg.subscription_days,
                            );
                            subscriptionTypeSelect.appendChild(option);
                        });

                        // إذا كان تعديل مشترك موجود، تعيين قيمة الاشتراك
                        if (subscriber) {
                            subscriptionTypeSelect.value =
                                subscriber.subscription_type || "";
                        }
                    })
                    .catch((error) => {
                        console.error("Error loading packages:", error);
                        subscriptionTypeSelect.innerHTML =
                            '<option value="">حدث خطأ في تحميل الباقات</option>';
                        showAlert(
                            "حدث خطأ في تحميل الباقات. الرجاء المحاولة لاحقاً",
                            "error",
                        );
                    });
            }

            function openItemModal() {
                document.getElementById("itemModal").style.display = "block";
            }

            function openPackageModal(packageData = null) {
                const form = document.getElementById("packageForm");
                form.reset();

                if (packageData) {
                    // تعبئة البيانات إذا كان تعديل باقة موجودة
                    document.getElementById("package_name").value =
                        packageData.package_name || "";
                    document.getElementById("package_price").value =
                        packageData.price || "";
                    document.getElementById("package_meals").value =
                        packageData.meals_count || "";
                    document.getElementById("package_duration").value =
                        packageData.subscription_days || "";
                    document.getElementById("edit_package_id").value =
                        packageData.package_id || "";

                    document.getElementById("modalTitle").textContent =
                        "تعديل الباقة";
                } else {
                    // إعداد النموذج لإضافة باقة جديدة
                    document.getElementById("edit_package_id").value = "";
                    document.getElementById("modalTitle").textContent =
                        "إضافة باقة جديدة";
                }

                document.getElementById("packageModal").style.display = "block";
            }

            function closeModal(modalId) {
                document.getElementById(modalId).style.display = "none";
            }
window.isSubmittingSubscriber = false;
   async function handleSubscriberSubmit(e) {
    e.preventDefault();
      if (window.isSubmittingSubscriber) {
        console.warn("تم منع إرسال مزدوج — العملية جارية بالفعل");
        return;
    }
    window.isSubmittingSubscriber = true;
    const btn = document.getElementById("saveSubscriberBtn");
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    btn.disabled = true;

    try {
        const subscriberId = document.getElementById("subscriberId").value;
        const isEditMode = !!subscriberId;
        let phone = document.getElementById("phone").value;
        const name = document.getElementById("name").value;
        const status = document.getElementById("status").value;
        const requestId = document.querySelector('input[name="requestId"]')?.value;

         // تنظيف الرقم من أي أحرف غير رقمية
        phone = phone.replace(/\D/g, ''); // حذف أي أحرف غير رقمية

        // إذا بدأ بـ 00 نحولها إلى بدون
        if (phone.startsWith("00")) {
            phone = phone.substring(2);
        }

        // الآن نراجع إذا كان سعودي أو دولي
        if (phone.startsWith("9665")) {
            // جاهز - رقم سعودي صحيح
        } else if (phone.startsWith("05")) {
            phone = "966" + phone.substring(1);
        } else if (phone.startsWith("5")) {
            phone = "966" + phone;
        } else if (phone.startsWith("966")) {
            // جاهز
        } else {
            // رقم دولي آخر - يترك كما هو (مثال 20 لمصر)
        }


        console.log('رقم الهاتف بعد التنسيق:', phone); // للتأكد من الصيغة الصحيحة

       


        // باقي كود تحضير البيانات...
        const startDate = document.getElementById("startDate").value;
        const subscriptionType = document.getElementById("subscriptionType");
        const selectedOption = subscriptionType.options[subscriptionType.selectedIndex];
        const days = selectedOption ? selectedOption.getAttribute("data-days") : 0;
        const meals = selectedOption ? selectedOption.getAttribute("data-meals") : 0;

        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + parseInt(days || 0));
const currentUser = localStorage.getItem("username"); 
        const formData = {
            name: name,
            phone: phone,
            start_date: startDate,
            end_date: endDate.toISOString().split("T")[0],
            subscription_type: subscriptionType.value,
            meals_remaining: meals,
            status: status,
             actionUser: currentUser
        };
        
        const method = isEditMode ? "PUT" : "POST";
        const url = isEditMode ? `/newstart/api/subscribers/${subscriberId}` : "/newstart/api/subscribers";

        const saveResponse = await fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
        });

        if (!saveResponse.ok) {
            const errorData = await saveResponse.json();
            throw new Error(errorData.message || "فشل في حفظ المشترك");
        }

        // التعامل مع النجاح
        if (isEditMode) {
            showAlert("تم تحديث المشترك بنجاح", "success");
        } else {
            showAlert("تم إضافة المشترك بنجاح", "success");
            
            // إرسال رسالة الواتساب
            const message = `📢 ${name} مرحباً:
تفاصيل اشتراكك في NEW START
👤 الاسم: ${name}
📱 الهاتف: ${phone}
📦 الباقة: ${formData.subscription_type}
🍽️ عدد الوجبات: ${meals}
📅 تاريخ البداية: ${startDate}
📅 تاريخ الانتهاء: ${formData.end_date}`;

            try {
                await fetch("/newstart/api/send-message", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        number: phone,
                        message: message
                    }),
                });
                console.log("تم إرسال الرسالة بنجاح");
            } catch (err) {
                console.error("فشل إرسال الرسالة:", err);
            }
        }

        // إذا كان هناك طلب مرتبط، قم بحذفه تلقائيًا بعد الحفظ الناجح
        if (requestId) {
            try {
                // استخدم دالة حذف مباشرة بدون تأكيد
                await deleteRequestSilently(requestId);
            } catch (error) {
                console.error("فشل في حذف الطلب:", error);
                // لا نعرض رسالة خطأ للمستخدم لأن الحفظ كان ناجحًا
            }
        }

        // تحديث الواجهة
        closeModal("subscriberModal");
        await loadSubscribers();
        await loadSubscriptionRequests();

    } catch (error) {
        console.error("Error:", error);
        showAlert("حدث خطأ: " + error.message, "error");
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
        window.isSubmittingSubscriber = false;
    }
}

// دالة جديدة لحذف الطلب بدون أي تأكيد أو رسائل
async function deleteRequestSilently(id) {
    if (!id) return;

    try {
        const url = `${GOOGLE_SCRIPT_URL}?action=deleteOrder&id=${encodeURIComponent(id)}`;
        const response = await fetch(url, { method: "GET", cache: "no-cache" });

        if (!response.ok) {
            throw new Error(`استجابة الخادم: ${response.status}`);
        }

        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.message || "فشل حذف الطلب");
        }
        
        console.log("تم حذف الطلب بنجاح:", id);
    } catch (err) {
        console.error("خطأ أثناء الحذف التلقائي للطلب:", err);
        throw err; // نعيد الخطأ للدالة المت calling
    }
}

// دالة approveRequest المعدلة
 function approveRequest(phone, name, packageName, requestId) {
                // فتح نافذة إضافة مشترك جديدة
                openSubscriberModal();
                
                // تعبئة البيانات التلقائية من الطلب
                document.getElementById("name").value = name || "";
                document.getElementById("phone").value = phone || "";
                
                // تخزين معرف الطلب في عنصر مخفي في النموذج
                let requestIdInput = document.querySelector('input[name="requestId"]');
                if (!requestIdInput) {
                    requestIdInput = document.createElement("input");
                    requestIdInput.type = "hidden";
                    requestIdInput.name = "requestId";
                    document.getElementById("subscriberForm").appendChild(requestIdInput);
                }
                requestIdInput.value = requestId;
                
                // تعيين تاريخ البداية لليوم
                const today = new Date().toISOString().split("T")[0];
                document.getElementById("startDate").value = today;

                // البحث عن الباقة المحددة وتحديدها
                if (packageName && packageName !== "غير محدد") {
                    setTimeout(() => {
                        const subscriptionType = document.getElementById("subscriptionType");
                        for (let i = 0; i < subscriptionType.options.length; i++) {
                            if (subscriptionType.options[i].text.includes(packageName)) {
                                subscriptionType.selectedIndex = i;
                                updateEndDate();
                                break;
                            }
                        }
                    }, 500);
                }

                // إزالة أي معالج حدث مسبق لمنع التكرار
                const subscriberForm = document.getElementById("subscriberForm");
                const newForm = subscriberForm.cloneNode(true);
                subscriberForm.parentNode.replaceChild(newForm, subscriberForm);
                
                // إعادة ربط المعالج الأصلي
                document.getElementById("subscriberForm").addEventListener("submit", handleSubscriberSubmit);
            }
            function handleItemSubmit(e) {
                e.preventDefault();

                const formData = {
                    item_name: document.getElementById("item_name").value,
                    price: document.getElementById("item_price").value,
                };

                fetch("/newstart/api/menu", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(formData),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        closeModal("itemModal");
                        loadMenu();
                        showAlert("تم إضافة الصنف بنجاح", "success");
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        showAlert("حدث خطأ أثناء إضافة الصنف", "error");
                    });
            }

            function handlePackageSubmit(e) {
                e.preventDefault();

                const packageId =
                    document.getElementById("edit_package_id").value;
                const isEditMode = packageId !== "";

                const formData = {
                    package_name: document.getElementById("package_name").value,
                    price: document.getElementById("package_price").value,
                    meals_count: document.getElementById("package_meals").value,
                    subscription_days:
                        document.getElementById("package_duration").value,
                   actionUser: getActionUser()
                };

                const url = isEditMode
                    ? `/newstart/api/packages/${packageId}`
                    : "/newstart/api/packages";
                const method = isEditMode ? "PUT" : "POST";

               fetch(url, {
    method: method,
    headers: {
        "Content-Type": "application/json",
    },
    body: JSON.stringify(formData),
})
    .then((response) => {
        if (!response.ok) {
            return response.json().then((err) => {
                throw new Error(
                    err.error || "حدث خطأ أثناء حفظ الباقة",
                );
            });
        }
        return response.json();
    })
    .then((data) => {
        showAlert(
            isEditMode
                ? "تم تحديث الباقة بنجاح"
                : "تم إضافة الباقة بنجاح",
            "success",
        );
        closeModal("packageModal");
        loadPackages();

        // إعادة تعيين النموذج بعد الحفظ
        document.getElementById("packageForm").reset();
        document.getElementById("edit_package_id").value = "";
    })
    .catch((error) => {
        console.error("Error:", error);
        showAlert(error.message, "error");
    });
            }

           /* function editSubscriber(id) {
                fetch(`/newstart/api/subscribers/${id}`)
                    .then((response) => response.json())
                    .then((subscriber) => {
                        openSubscriberModal(subscriber);
                    })
                    .catch((error) =>
                        console.error("Error fetching subscriber:", error),
                    );
            }
*/
            function deleteSubscriber(id) {
                if (confirm("هل أنت متأكد من حذف هذا المشترك؟")) {
                    fetch(`/newstart/api/subscribers/${id}`, {
                        method: "DELETE",
                    })
                        .then((response) => {
                            if (response.ok) {
                                loadSubscribers();
                                showAlert("تم حذف المشترك بنجاح", "success");
                            } else {
                                throw new Error("Failed to delete subscriber");
                            }
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                            showAlert("حدث خطأ أثناء حذف المشترك", "error");
                        });
                }
            }

            const userSession = sessionStorage.getItem("user");
const user = JSON.parse(userSession);

// عند الضغط على زر خصم وجبة
function deductMeal(subscriberId, subscriberName, subscriptionType) {
    fetch(`/newstart/api/subscribers/${subscriberId}/deduct-meal`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            subscriber_name: subscriberName,
            subscription_type: subscriptionType,
            username: user.username   // 👈 هنا نرسل اسم المستخدم
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("تم الخصم بواسطة: " + user.username);
        } else {
            alert("خطأ: " + data.error);
        }
    })
    .catch(err => console.error("Error:", err));
}

            function generateQR(id, name) {
                const qrModal = document.getElementById("qrModal");
                const qrcodeDiv = document.getElementById("qrcode");

                // مسح أي QR كود سابق
                qrcodeDiv.innerHTML = "";
                document.getElementById("qr-name").textContent = name;
                document.getElementById("qr-id").textContent = `${id}`;

                // إنشاء QR كود جديد
                new QRCode(qrcodeDiv, {
                    text: `${id}`,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H,
                });

                qrModal.style.display = "block";
            }

            // دالة إغلاق النافذة
            function closeQRModal() {
                document.getElementById("qrModal").style.display = "none";
            }

            // جعل الدوال متاحة عالمياً
            window.closeQRModal = closeQRModal;
            function saveQRCode() {
                const qrImg = document
                    .getElementById("qrcode")
                    .querySelector("img");
                if (!qrImg) {
                    showAlert(
                        "الرجاء الانتظار حتى يكتمل توليد QR Code",
                        "error",
                    );
                    return;
                }

                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = qrImg.width;
                canvas.height = qrImg.height;

                // رسم الصورة على Canvas
                ctx.drawImage(qrImg, 0, 0);

                // إنشاء رابط للتحميل
                const link = document.createElement("a");
                link.download = `QR_${document.getElementById("qr-id").textContent.replace("ID: ", "")}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            }
function approveRequest(phone, name, packageName, requestId) {
    // فتح نافذة إضافة مشترك جديدة
    openSubscriberModal();
    
    // تعبئة البيانات التلقائية من الطلب
    document.getElementById("name").value = name || "";
    document.getElementById("phone").value = phone || "";
    
    // تخزين معرف الطلب في عنصر مخفي في النموذج
    let requestIdInput = document.querySelector('input[name="requestId"]');
    if (!requestIdInput) {
        requestIdInput = document.createElement("input");
        requestIdInput.type = "hidden";
        requestIdInput.name = "requestId";
        document.getElementById("subscriberForm").appendChild(requestIdInput);
    }
    requestIdInput.value = requestId;
    
    // تعيين تاريخ البداية لليوم
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("startDate").value = today;

    // البحث عن الباقة المحددة وتحديدها
    if (packageName && packageName !== "غير محدد") {
        setTimeout(() => {
            const subscriptionType = document.getElementById("subscriptionType");
            for (let i = 0; i < subscriptionType.options.length; i++) {
                if (subscriptionType.options[i].text.includes(packageName)) {
                    subscriptionType.selectedIndex = i;
                    updateEndDate();
                    break;
                }
            }
        }, 500);
    }


    
    // تعديل معالج النموذج لإضافة وظيفة حذف الطلب بعد الحفظ
    const originalSubmitHandler = subscriberForm.onsubmit;
    subscriberForm.onsubmit = async function(e) {
        e.preventDefault();
        
        // تنفيذ المعالج الأصلي أولاً
        if (originalSubmitHandler) {
            await originalSubmitHandler(e);
        } else {
            await handleSubscriberSubmit(e);
        }
        
        // إذا تم حفظ المشترك بنجاح، نقوم بحذف الطلب
        const requestId = document.querySelector('input[name="requestId"]').value;

        // إعادة تحميل قائمة طلبات الاشتراك
        loadSubscriptionRequests();
    };
}
            // دالة جديدة لفتح النافذة مع البيانات
            function openSubscriberModalWithData(data) {
                const modal = document.getElementById("subscriberModal");

                // تعبئة الحقول
                document.getElementById("name").value = data.name || "";
                document.getElementById("phone").value = data.phone || "";
                document.getElementById("startDate").value =
                    data.start_date || "";
                document.getElementById("status").value = data.status || "نشط";

                // تعيين عنوان النافذة
                document.getElementById("modalTitle").textContent =
                    "إضافة مشترك جديد من طلب";

                // إظهار النافذة
                modal.style.display = "block";

                // تحميل أنواع الاشتراكات وتحديد النوع المناسب
                loadSubscriptionTypesForRequest(data.subscription_type);
            }

            // دالة معدلة لتحميل أنواع الاشتراكات
            function loadSubscriptionTypesForRequest(packageName) {
                const subscriptionTypeSelect =
                    document.getElementById("subscriptionType");
                subscriptionTypeSelect.innerHTML =
                    '<option value="">جاري تحميل الباقات...</option>';

                fetch("/newstart/api/packages/list")
                    .then((response) => response.json())
                    .then((packages) => {
                        subscriptionTypeSelect.innerHTML =
                            '<option value="">اختر نوع الاشتراك</option>';

                        packages.forEach((pkg) => {
                            const option = document.createElement("option");
                            option.value = `${pkg.package_name} - ${pkg.subscription_days} يوم - ${pkg.price} ريال (${pkg.meals_count} وجبة)`;
                            option.textContent = `${pkg.package_name} - ${pkg.subscription_days} يوم - ${pkg.price} ريال (${pkg.meals_count} وجبة)`;
                            option.setAttribute("data-meals", pkg.meals_count);
                            option.setAttribute(
                                "data-days",
                                pkg.subscription_days,
                            );
                            subscriptionTypeSelect.appendChild(option);
                        });

                        // تحديد الباقة المختارة إن وجدت
                        if (packageName) {
                            const options = subscriptionTypeSelect.options;
                            for (let i = 0; i < options.length; i++) {
                                if (options[i].text.includes(packageName)) {
                                    subscriptionTypeSelect.selectedIndex = i;
                                    updateEndDate(); // تحديث تاريخ الانتهاء تلقائياً
                                    break;
                                }
                            }
                        }
                    })
                    .catch((error) => {
                        console.error("Error loading packages:", error);
                        subscriptionTypeSelect.innerHTML =
                            '<option value="">حدث خطأ في تحميل الباقات</option>';
                    });
            }

           
    async function rejectRequest(id) {
    if (!id) {
        showAlert("معرّف الطلب غير صالح", "error");
        return;
    }

    if (!confirm(`هل أنت متأكد من حذف الطلب رقم ${id}؟`)) return;

    try {
        await deleteRequestSilently(id);
        showAlert("تم حذف الطلب بنجاح", "success");
        loadSubscriptionRequests();
    } catch (error) {
        console.error("Error:", error);
        showAlert(`حدث خطأ أثناء الحذف: ${error.message}`, "error");
    }
}
      let ACTIONUSER = "System"; // القيمة الافتراضية

document.addEventListener('DOMContentLoaded', () => {
    const savedSession = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
    if (savedSession) {
        ACTIONUSER = JSON.parse(savedSession).username || "System";
    }
});
        
        // تحميل البيانات عند فتح الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            loadSubscriptionRequests();
        });

            function filterSubscribers() {
                const search =
                    document.getElementById("subscriberSearch").value;
                loadSubscribers(search);
            }

            function resetSubscriberFilter() {
                document.getElementById("subscriberSearch").value = "";
                loadSubscribers();
            }

            function filterPackages() {
                const search = document.getElementById("packageSearch").value;
                loadPackages(search);
            }

            function resetPackageFilter() {
                document.getElementById("packageSearch").value = "";
                loadPackages();
            }

            function showAlert(message, type) {
                const alertDiv = document.createElement("div");
                alertDiv.className = `alert alert-${type}`;
                alertDiv.textContent = message;

                document.querySelector(".main-content").prepend(alertDiv);

                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }

            function getStatusClass(status) {
                switch (status) {
                    case "نشط":
                        return "status-active";
                    case "غير نشط":
                        return "status-inactive";
                    case "موقوف":
                        return "status-suspended";
                    default:
                        return "";
                }
            }
            function editSubscriber(id) {
                fetch(`/newstart/api/subscribers/${id}`)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.json();
                    })
                    .then((subscriber) => {
                        console.log("Subscriber data:", subscriber); // للتأكد من البيانات المستلمة
                        openSubscriberModal(subscriber);
                    })
                    .catch((error) => {
                        console.error("Error fetching subscriber:", error);
                        showAlert(
                            "حدث خطأ أثناء تحميل بيانات المشترك",
                            "error",
                        );
                    });
            }
            function deleteSubscriber(id) {
    if (confirm("هل أنت متأكد من حذف هذا المشترك؟")) {
        const btn = event.target.closest("button");
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        fetch(`/newstart/api/subscribers/${id}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ actionUser: ACTIONUSER }) // تمرير اسم المستخدم الحالي
        })
        .then((response) => {
            if (!response.ok) throw new Error("فشل في الحذف");
            return response.json();
        })
        .then((data) => {
            showAlert("تم حذف المشترك بنجاح", "success");
            loadSubscribers();
        })
        .catch((error) => {
            console.error("Error:", error);
            showAlert(
                "حدث خطأ أثناء الحذف: " + error.message,
                "error",
            );
        })
        .finally(() => {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        });
    }
}
            function deductMeal(
                subscriberId,
                subscriberName,
                subscriptionType,
            ) {
                if (confirm(`هل تريد خصم وجبة من ${subscriberName}؟`)) {
                    const btn = event.target.closest("button");
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    btn.disabled = true;

                    fetch(`/newstart/api/subscribers/${subscriberId}/deduct-meal`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            subscriber_name: subscriberName,
                            subscription_type: subscriptionType,
                            actionUser: ACTIONUSER
                        }),
                    })
                        .then((response) => {
                            if (!response.ok) {
                                return response.json().then((err) => {
                                    throw new Error(err.error);
                                });
                            }
                            return response.json();
                        })
                        .then((data) => {
                            if (data.success) {
                                showAlert(
                                    `تم خصم وجبة بنجاح. الوجبات المتبقية: ${data.meals_remaining}`,
                                    "success",
                                );
                                loadSubscribers();
                            }
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                            showAlert(
                                `حدث خطأ أثناء خصم الوجبة: ${error.message}`,
                                "error",
                            );
                        })
                        .finally(() => {
                            btn.innerHTML = originalHtml;
                            btn.disabled = false;
                        });
                }
            }
            function editPackage(packageId) {
                fetch(`/newstart/api/packages/${packageId}`)
                    .then((response) => response.json())
                    .then((packageData) => {
                        // فتح نافذة التعديل مع بيانات الباقة
                        document.getElementById("package_name").value =
                            packageData.package_name;
                        document.getElementById("package_price").value =
                            packageData.price;
                        document.getElementById("package_meals").value =
                            packageData.meals_count;
                        document.getElementById("package_duration").value =
                            packageData.subscription_days;

                        // تخزين ID الباقة في حقل مخفي
                        document.getElementById("edit_package_id").value =
                            packageId;

                        // فتح النافذة المنبثقة
                        document.getElementById("packageModal").style.display =
                            "block";
                        document.getElementById("modalTitle").textContent =
                            "تعديل الباقة";
                    })
                    .catch((error) => {
                        console.error("Error fetching package:", error);
                        showAlert("حدث خطأ أثناء تحميل بيانات الباقة", "error");
                    });
            }

            // دالة حذف الباقة
           function deletePackage(packageId, packageName) {
    if (confirm(`هل أنت متأكد من حذف باقة "${packageName}"؟`)) {
       
          const currentUser = getActionUser(); 
        fetch(`/newstart/api/packages/${packageId}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ actionUser: currentUser }) // تمرير اسم المستخدم
        })
            .then((response) => {
                if (!response.ok) throw new Error("فشل في الحذف");
                return response.json();
            })
            .then((data) => {
                showAlert("تم حذف الباقة بنجاح", "success");
                loadPackages();
            })
            .catch((error) => {
                console.error("Error:", error);
                showAlert(
                    `حدث خطأ أثناء الحذف: ${error.message}`,
                    "error",
                );
            });
    }
}

            // دالة مساعدة لجلب الطلبات
            async function fetchRequests() {
                const response = await fetch(
                    `${GOOGLE_SCRIPT_URL}?action=getOrders`,
                );
                if (!response.ok) throw new Error("فشل في جلب الطلبات");
                const data = await response.json();
                return Array.isArray(data) ? data : Object.values(data);
            }

            // دالة مساعدة لتحديث حالة الطلب
            async function updateRequestStatus(phone, status) {
                const response = await fetch(
                    `${GOOGLE_SCRIPT_URL}?action=updateStatus`,
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ phone, status }),
                    },
                );
                if (!response.ok) throw new Error("فشل في تحديث حالة الطلب");
            }
            function generateReport() {
    const subscriberId = document.getElementById("reportSubscriberId").value;
    if (!subscriberId) {
        showAlert("الرجاء إدخال رقم المشترك", "error");
        return;
    }

    const reportResult = document.getElementById("reportResult");
    reportResult.innerHTML = '<p class="loading">جاري تحميل التقرير...</p>';

    fetch(`/newstart/api/subscribers/${subscriberId}/report`)
        .then(response => {
            if (!response.ok) {
                throw new Error("فشل في جلب التقرير");
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            renderReport(data);
        })
        .catch(error => {
            reportResult.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
        });
}

function renderReport(data) {
     const user = JSON.parse(userSession);
    const { subscriber, mealLogs, totalDeducted, mealsRemaining ,username} = data;
    const reportResult = document.getElementById("reportResult");

    let html = `
        <div class="report-summary">
            <h3>تقرير المشترك: ${subscriber.name}</h3>
            <table class="summary-table">
                <tr>
                    <th>رقم المشترك</th>
                    <td>${subscriber.subscriber_id}</td>
                </tr>
                <tr>
                    <th>رقم الجوال</th>
                    <td>${subscriber.phone}</td>
                </tr>
                <tr>
                    <th>نوع الاشتراك</th>
                    <td>${subscriber.subscription_type}</td>
                </tr>
                <tr>
                    <th>الحالة</th>
                    <td>${subscriber.status}</td>
                </tr>
                <tr>
                    <th>الوجبات المخصومة</th>
                    <td>${totalDeducted}</td>
                </tr>
                <tr>
                    <th>الوجبات المتبقية</th>
                    <td>${mealsRemaining}</td>
                </tr>
            </table>
        </div>
    `;

    if (mealLogs.length > 0) {
        html += `
            <div class="meal-logs" style="margin-top: 30px;">
                <h4>سجل خصم الوجبات</h4>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>اسم المشترك</th>
                                <th>نوع الاشتراك</th>
                                <th>عدد الوجبات المخصومة</th>
                                <th>الوجبات المتبقية بعد الخصم</th>
                                <th>المستخدم</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        mealLogs.forEach(log => {
            html += `
                <tr>
                    <td>${new Date(log.date).toLocaleString()}</td>
                    <td>${log.subscriber_name}</td>
                    <td>${log.subscription_type}</td>
                    <td>${log.meals_deducted}</td>
                    <td>${log.meals_remaining}</td>
                    <td>${log.user}</td>
                </tr>
            `;
        });

        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else {
        html += `<p>لا توجد سجلات لخصم الوجبات.</p>`;
    }

    reportResult.innerHTML = html;
}
function logout() {
    // إزالة جلسة المستخدم
    localStorage.removeItem('userSession');
    sessionStorage.removeItem('userSession');
    
    // توجيه المستخدم إلى صفحة تسجيل الدخول
    window.location.href = '/newstart';
}
async function createBackup() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...';
    btn.disabled = true;

    try {
        const response = await fetch('/newstart/api/backup');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('backupResult').innerHTML = 
                `<div class="alert alert-success">
                    تم إنشاء النسخة الاحتياطية بنجاح: ${data.backupPath}
                </div>`;
            loadBackups();
        } else {
            document.getElementById('backupResult').innerHTML = 
                `<div class="alert alert-error">${data.message}</div>`;
        }
    } catch (error) {
        document.getElementById('backupResult').innerHTML = 
            `<div class="alert alert-error">حدث خطأ أثناء الاتصال بالخادم</div>`;
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// دالة لتحميل قائمة النسخ الاحتياطية
async function loadBackups() {
    try {
        const response = await fetch('/newstart/api/backups');
        const backups = await response.json();
        
        const list = document.getElementById('backupsList');
        list.innerHTML = '';
        
        if (backups.length === 0) {
            list.innerHTML = `<tr><td colspan="4">لا توجد نسخ احتياطية</td></tr>`;
            return;
        }
        
        backups.forEach(backup => {
            const formattedDate = new Date(backup.date).toLocaleString();
            const formattedSize = formatFileSize(backup.size);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${backup.name}</td>
                <td>${formattedSize}</td>
                <td>${formattedDate}</td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="downloadBackup('${backup.name}')">
                        <i class="fas fa-download"></i> تنزيل
                    </button>
                 <!--   <button class="btn btn-danger btn-sm" onclick="deleteBackup('${backup.name}')">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                    -->
                </td>
            `;
            list.appendChild(tr);
        });
    } catch (error) {
        console.error('Error loading backups:', error);
        document.getElementById('backupsList').innerHTML = 
            `<tr><td colspan="4">حدث خطأ أثناء تحميل النسخ الاحتياطية</td></tr>`;
    }
}

// دالة لتنزيل نسخة احتياطية
function downloadBackup(filename) {
    window.open(`/newstart/api/backups/${filename}`, '_blank');
}

// دالة لحذف نسخة احتياطية
async function deleteBackup(filename) {
    if (!confirm(`هل أنت متأكد من حذف النسخة الاحتياطية "${filename}"؟`)) return;
    
    try {
        const response = await fetch(`/newstart/api/backups/${filename}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            showAlert('تم حذف النسخة الاحتياطية بنجاح', 'success');
            loadBackups();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error deleting backup:', error);
        showAlert(`حدث خطأ أثناء الحذف: ${error.message}`, 'error');
    }
}

// دالة مساعدة لتنسيق حجم الملف
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' بايت';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' كيلوبايت';
    return (bytes / 1048576).toFixed(1) + ' ميجابايت';
}
// دالة لعرض نافذة الاستعادة
async function showRestoreModal() {
    const modal = document.getElementById('restoreModal');
    const select = document.getElementById('restoreFileSelect');
    
    // تحميل النسخ الاحتياطية
    try {
        const response = await fetch('/newstart/api/backups');
        const backups = await response.json();
        
        select.innerHTML = '<option value="">-- اختر نسخة احتياطية --</option>';
        
        backups.forEach(backup => {
            const option = document.createElement('option');
            option.value = backup.name;
            option.textContent = `${backup.name} (${new Date(backup.date).toLocaleString()})`;
            option.setAttribute('data-size', backup.size);
            option.setAttribute('data-date', backup.date);
            select.appendChild(option);
        });
        
        modal.style.display = 'block';
    } catch (error) {
        console.error('Error loading backups:', error);
        showAlert('حدث خطأ أثناء تحميل النسخ الاحتياطية', 'error');
    }
}

// دالة لتحديث معاينة النسخة
function updateRestorePreview() {
    const select = document.getElementById('restoreFileSelect');
    const preview = document.getElementById('restorePreview');
    const backupInfo = document.getElementById('backupInfo');
    const confirmBtn = document.getElementById('confirmRestoreBtn');
    
    if (select.value) {
        const selectedOption = select.options[select.selectedIndex];
        const size = selectedOption.getAttribute('data-size');
        const date = selectedOption.getAttribute('data-date');
        
        backupInfo.innerHTML = `
            <p><strong>الاسم:</strong> ${select.value}</p>
            <p><strong>الحجم:</strong> ${formatFileSize(size)}</p>
            <p><strong>التاريخ:</strong> ${new Date(date).toLocaleString()}</p>
        `;
        
        preview.style.display = 'block';
        confirmBtn.disabled = false;
    } else {
        preview.style.display = 'none';
        confirmBtn.disabled = true;
    }
}

// دالة لتأكيد الاستعادة
async function confirmRestore() {
    const backupFile = document.getElementById('restoreFileSelect').value;
    
    if (!backupFile) {
        showAlert('الرجاء اختيار نسخة احتياطية', 'error');
        return;
    }
    
    if (!confirm(`⚠️  تحذير: هذا الإجراء لا يمكن التراجع عنه!\n\nهل أنت متأكد من استعادة النسخة "${backupFile}"؟\nجميع البيانات الحالية سيتم حذفها واستبدالها بالبيانات من النسخة الاحتياطية.`)) {
        return;
    }
    
    const btn = document.getElementById('confirmRestoreBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الاستعادة...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/newstart/api/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ backupFile })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('تم استعادة النسخة الاحتياطية بنجاح', 'success');
            closeModal('restoreModal');
            
            // إعادة تحميل البيانات بعد الاستعادة
            setTimeout(() => {
                location.reload(); // إعادة تحميل الصفحة للتأكد من تحديث جميع البيانات
            }, 2000);
            
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error restoring backup:', error);
        showAlert(`حدث خطأ أثناء الاستعادة: ${error.message}`, 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
    
    // تنظيف حقول الاستعادة عند الإغلاق
    if (modalId === 'restoreModal') {
        document.getElementById('restoreFileSelect').value = '';
        document.getElementById('restorePreview').style.display = 'none';
        document.getElementById('confirmRestoreBtn').disabled = true;
    }
}
async function loadLogs(search = "") {
    const tbody = document.getElementById("logsTableBody");
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">جاري التحميل...</td></tr>`;

    let url = "/api/logs";
    if (search) url = `/api/logs/search?q=${encodeURIComponent(search)}`;

    try {
        const res = await fetch(url);
        const logs = await res.json();

        tbody.innerHTML = "";

        if (logs.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">لا توجد سجلات</td></tr>`;
            return;
        }

        logs.forEach(log => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${log.log_id}</td>
                <td>${log.timestamp}</td>
                <td>${log.username}</td>
                <td>${log.action}</td>
                <td>${log.details}</td>
            `;
            tbody.appendChild(tr);
        });
    } catch (err) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:red">خطأ في تحميل السجلات</td></tr>`;
    }
}

// دالة لعرض قسم السجلات
function showLogsSection() {
    showSection("logsContent");
    loadLogs();
}

// دالة لتصفية السجلات
function filterLogs() {
    const search = document.getElementById("logsSearch").value;
    loadLogs(search);
}

// دالة لإعادة تعيين تصفية السجلات
function resetLogsFilter() {
    document.getElementById("logsSearch").value = "";
    loadLogs();
}

// دالة لتصفية السجلات
function filterLogs() {
    const search = document.getElementById("logsSearch").value;
    loadLogs(search);
}

// دالة لإعادة تعيين التصفية
function resetLogsFilter() {
    document.getElementById("logsSearch").value = "";
    loadLogs();
}
function getActionUser() {
  // 1) من localStorage (اللي خزنته بعد تسجيل الدخول)
  const fromLS = localStorage.getItem('username');
  if (fromLS) return fromLS;

  // 2) من userSession لو موجود
  try {
    const sess = JSON.parse(
      localStorage.getItem('userSession') ||
      sessionStorage.getItem('userSession') || '{}'
    );
    if (sess && sess.username) return sess.username;
  } catch (_) {}

  // 3) من input مخفي لو موجود
  const el = document.getElementById('current_user');
  if (el && el.value) return el.value;

  // 4) افتراضي
  return 'System';
}

// (اختياري) عبّي الحقل المخفي تلقائياً إن موجود
document.addEventListener('DOMContentLoaded', () => {
  const el = document.getElementById('current_user');
  if (el) el.value = getActionUser();
});
// دالة تحميل العملاء للإشعارات
function loadClientsForNotifications() {
    fetch("/newstart/api/subscribers")
        .then(response => response.json())
        .then(clients => {
            const clientsList = document.getElementById("clientsList");
            clientsList.innerHTML = "";
            
            clients.forEach(client => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="client-checkbox" data-phone="${client.phone}" data-name="${client.name}">
                    </td>
                    <td>${client.name}</td>
                    <td>${client.phone}</td>
                `;
                clientsList.appendChild(tr);
            });
        })
        .catch(error => {
            console.error("Error loading clients:", error);
            showAlert("حدث خطأ أثناء تحميل قائمة العملاء", "error");
        });
}

// دالة لفتح نافذة التعديل مع البيانات
  function editSubscriber(id) {
            fetch(`/newstart/api/subscribers/${id}`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then((subscriber) => {
                    openEditSubscriberModal(subscriber);
                })
                .catch((error) => {
                    console.error("Error fetching subscriber:", error);
                    showAlert("حدث خطأ أثناء تحميل بيانات المشترك", "error");
                });
        }

         // دالة لتحميل الباقات في قائمة التعديل
        function loadPackagesForEdit() {
            const subscriptionTypeSelect = document.getElementById("edit_subscription_type");
            subscriptionTypeSelect.innerHTML = '<option value="">جاري تحميل الباقات...</option>';
            
            fetch("/newstart/api/packages/list")
                .then((response) => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then((packages) => {
                    subscriptionTypeSelect.innerHTML = '<option value="">اختر نوع الاشتراك</option>';
                    
                    packages.forEach((pkg) => {
                        const option = document.createElement("option");
                        const optionText = `${pkg.package_name} - ${pkg.subscription_days} يوم - ${pkg.price} ريال (${pkg.meals_count} وجبة)`;
                        option.value = optionText;
                        option.textContent = optionText;
                        option.setAttribute("data-days", pkg.subscription_days);
                        option.setAttribute("data-meals", pkg.meals_count);
                        subscriptionTypeSelect.appendChild(option);
                    });
                    
                    // تحديد الباقة الحالية إذا كانت متوفرة
                    const currentSubscription = document.getElementById("current_subscription").textContent;
                    if (currentSubscription) {
                        for (let i = 0; i < subscriptionTypeSelect.options.length; i++) {
                            if (subscriptionTypeSelect.options[i].value === currentSubscription) {
                                subscriptionTypeSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                })
                .catch((error) => {
                    console.error("Error loading packages:", error);
                    subscriptionTypeSelect.innerHTML = '<option value="">حدث خطأ في تحميل الباقات</option>';
                    showAlert("حدث خطأ في تحميل الباقات. الرجاء المحاولة لاحقاً", "error");
                });
        }

        // دالة لفتح نافذة التعديل مع البيانات
     function openEditSubscriberModal(subscriber) {
    // تعبئة قسم التفاصيل الحالية
    document.getElementById("current_id").textContent = subscriber.subscriber_id;
    document.getElementById("current_name").textContent = subscriber.name;
    document.getElementById("current_phone").textContent = subscriber.phone;
    document.getElementById("current_subscription").textContent = subscriber.subscription_type;
    document.getElementById("current_start_date").textContent = subscriber.start_date;
    document.getElementById("current_end_date").textContent = subscriber.end_date;
    document.getElementById("current_status").textContent = subscriber.status;
    document.getElementById("current_meals").textContent = subscriber.meals_remaining;
    
    // تعبئة حقول التعديل
    document.getElementById("edit_subscriber_id").value = subscriber.subscriber_id;
    document.getElementById("edit_name").value = subscriber.name;
    document.getElementById("edit_phone").value = subscriber.phone;
    document.getElementById("edit_status").value = subscriber.status;
    document.getElementById("edit_meals").value = subscriber.meals_remaining;
    
    // تعبئة حقول التواريخ
    document.getElementById("display_start_date").value = subscriber.start_date;
    document.getElementById("display_end_date").value = subscriber.end_date;
    
    // تحميل الباقات في القائمة المنسدلة
    loadPackagesForEdit();
    
    // إظهار النافذة المنبثقة
    document.getElementById("editSubscriberModal").style.display = "block";
}

// دالة جديدة للتعامل مع تعديل المشترك
async function handleEditSubscriberSubmit() {
    const subscriberId = document.getElementById("edit_subscriber_id").value;
    const name = document.getElementById("edit_name").value;
    const phone = document.getElementById("edit_phone").value;
    const status = document.getElementById("edit_status").value;
    const meals_remaining = document.getElementById("edit_meals").value;
    const subscription_type = document.getElementById("edit_subscription_type").value;
    
    // الحصول على قيم التواريخ من الحقول القابلة للتعديل
    const start_date = document.getElementById("display_start_date").value;
    const end_date = document.getElementById("display_end_date").value;
    
    const currentUser = getActionUser();

    // تحضير البيانات للإرسال
    const formData = {
        name: name,
        phone: phone,
        status: status,
        start_date: start_date,
        end_date: end_date,
        subscription_type: subscription_type,
        meals_remaining: parseInt(meals_remaining) || 0,
        actionUser: currentUser
    };

    const btn = document.querySelector("#editSubscriberForm button[type='submit']");
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    btn.disabled = true;

    try {
        const response = await fetch(`/newstart/api/subscribers/${subscriberId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "فشل في تحديث المشترك");
        }

        showAlert("تم تحديث المشترك بنجاح", "success");
        closeModal("editSubscriberModal");
        loadSubscribers(); // إعادة تحميل القائمة
    } catch (error) {
        console.error("Error:", error);
        showAlert("حدث خطأ أثناء التحديث: " + error.message, "error");
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
        // إعداد معالجات الأحداث
        document.getElementById("editSubscriberForm").addEventListener("submit", function(e) {
            e.preventDefault();
            handleEditSubscriberSubmit();
        });
        // تعديل الدالة الأصلية لاستخدام النافذة الجديدة
        function editSubscriber(id) {
            fetch(`/newstart/api/subscribers/${id}`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then((subscriber) => {
                    openEditSubscriberModal(subscriber);
                })
                .catch((error) => {
                    console.error("Error fetching subscriber:", error);
                    showAlert("حدث خطأ أثناء تحميل بيانات المشترك", "error");
                });
        }
// دالة إرسال الإشعارات
async function sendNotifications() {
    const message = document.getElementById("notificationMessage").value.trim();
    if (!message) {
        showAlert("الرجاء كتابة نص الرسالة", "error");
        return;
    }
    
    const selectedClients = Array.from(document.querySelectorAll('.client-checkbox:checked'));
    if (selectedClients.length === 0) {
        showAlert("الرجاء اختيار عميل واحد على الأقل", "error");
        return;
    }
    
    const btn = document.getElementById("sendNotificationBtn");
    const originalText = btn.innerHTML;
    const statusEl = document.getElementById("notificationStatus");
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
    btn.disabled = true;
    statusEl.textContent = `0/${selectedClients.length} تم إرسالها`;
    
    let successCount = 0;
    let failCount = 0;
    
    // إرسال الرسائل مع وجود فاصل زمني 5 ثواني بين كل رسالة
    for (let i = 0; i < selectedClients.length; i++) {
        const client = selectedClients[i];
        const phone = client.getAttribute('data-phone');
        const name = client.getAttribute('data-name');
        
        try {
            // إضافة اسم العميل للرسالة بشكل تلقائي
            const personalizedMessage = `عزيزي ${name},\n${message}`;
            
            const response = await fetch("/newstart/api/send-message", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    number: phone,
                    message: personalizedMessage
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                successCount++;
            } else {
                failCount++;
                console.error(`Failed to send to ${phone}:`, result.error);
            }
        } catch (error) {
            failCount++;
            console.error(`Error sending to ${phone}:`, error);
        }
        
        statusEl.textContent = `${i + 1}/${selectedClients.length} تم إرسالها (${successCount} نجاح, ${failCount} فشل)`;
        
        // الانتظار 5 ثواني قبل الإرسال التالي (ما عدا للعنصر الأخير)
        if (i < selectedClients.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 5000));
        }
    }
    
    btn.innerHTML = originalText;
    btn.disabled = false;
    
    showAlert(`تم إرسال الإشعارات: ${successCount} نجاح, ${failCount} فشل`, 
              failCount === 0 ? "success" : "warning");
}
// إضافة مستمع الحدث لاختيار الملف
document.getElementById('restoreFileSelect').addEventListener('change', updateRestorePreview);


// جعل الدوال متاحة عالمياً
window.createBackup = createBackup;
window.downloadBackup = downloadBackup;
window.deleteBackup = deleteBackup;
window.showRestoreModal = showRestoreModal;
window.confirmRestore = confirmRestore;
// عند عرض قسم الإعدادات


            // جعل الدوال متاحة عالمياً للاستدعاء من HTML
            window.showSection = showSection;
            window.editSubscriber = editSubscriber;
            window.deleteSubscriber = deleteSubscriber;
            window.deductMeal = deductMeal;
            window.generateQR = generateQR;
            window.approveRequest = approveRequest;
            window.rejectRequest = rejectRequest;
            window.filterSubscribers = filterSubscribers;
            window.resetSubscriberFilter = resetSubscriberFilter;
            window.filterPackages = filterPackages;
            window.resetPackageFilter = resetPackageFilter;
            window.loadSubscriptionRequests = loadSubscriptionRequests;
            window.showLogsSection = showLogsSection;
window.filterLogs = filterLogs;
window.resetLogsFilter = resetLogsFilter;
window.loadLogs = loadLogs;
        </script>
    </body>
</html>
